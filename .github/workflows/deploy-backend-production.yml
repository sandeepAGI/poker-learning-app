name: Deploy Backend to Production

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend-production.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  AZURE_WEBAPP_NAME: poker-api-demo
  ACR_NAME: pokerlearningacr
  IMAGE_NAME: poker-backend
  PYTHON_VERSION: '3.12'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run tests
        env:
          TEST_MODE: 1
          ANTHROPIC_API_KEY: test-key
        run: |
          cd backend
          # Run only fast regression tests (same as pre-commit hook)
          # Full test suite runs in nightly-tests.yml
          PYTHONPATH=. pytest \
            tests/test_action_processing.py \
            tests/test_state_advancement.py \
            tests/test_turn_order.py \
            tests/test_fold_resolution.py \
            -v --tb=short

  build-and-deploy:
    name: Build Docker Image & Deploy
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to Azure Container Registry
        run: |
          az acr login --name ${{ env.ACR_NAME }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
            ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          images: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Wait for deployment
        run: |
          echo "Waiting 45 seconds for container to start..."
          sleep 45

      - name: Verify deployment
        run: |
          MAX_RETRIES=5
          RETRY=0

          while [ $RETRY -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY + 1))/$MAX_RETRIES: Checking health endpoint..."

            if curl -f -m 15 https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health; then
              echo "✅ Backend deployment successful!"
              exit 0
            fi

            RETRY=$((RETRY + 1))
            if [ $RETRY -lt $MAX_RETRIES ]; then
              echo "Health check failed, waiting 15 seconds before retry..."
              sleep 15
            fi
          done

          echo "❌ Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Deployment failed! Check logs at:"
          echo "https://portal.azure.com"
